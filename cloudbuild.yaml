# cloudbuild.yaml â€” DEPLOY SECTION
substitutions:
  _SERVICE: innerpeace-api
  _REGION: europe-west2
  # build to AR and deploy this tag (keep your existing build steps)
  _IMAGE: europe-west2-docker.pkg.dev/$PROJECT_ID/apps/innerpeace-api:$SHORT_SHA
  _USE_MEET_SECRET: use-meet-prod

steps:
  # ... your build & push steps ...

  # Remove literal USE_MEET if present (no-op if not)
  - name: gcr.io/cloud-builders/gcloud
    id: pre-clean-env
    entrypoint: bash
    args:
      - -c
      - >
        gcloud run services update "$_SERVICE"
        --region="$_REGION" --project="$PROJECT_ID"
        --remove-env-vars=USE_MEET || true

  # Deploy with USE_MEET as a secret-backed var (type now stable forever)
  - name: gcr.io/cloud-builders/gcloud
    id: deploy
    args:
      [
        "run","deploy","$_SERVICE",
        "--image","$_IMAGE",
        "--region","$_REGION",
        "--project","$PROJECT_ID",
        "--set-secrets","USE_MEET=${_USE_MEET_SECRET}:latest",
        "--update-env-vars","SEND_UPDATES=all,GOOGLE_DELEGATED_USER=thomaspal@innerpeace-developer.co.uk,MANAGER_CALENDAR_ID=thomaspal@innerpeace-developer.co.uk"
      ]

images:
  - $_IMAGE
