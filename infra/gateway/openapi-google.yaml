swagger: "2.0"
info:
  title: InnerPeace API
  version: "1.0.0"

schemes: ["https"]
produces: ["application/json"]
basePath: "/"

# Default: all ops require Supabase JWT unless overridden with security: []
security:
  - supabase_jwt: []

# ===== Auth: Supabase access token validation =====
securityDefinitions:
  supabase_jwt:
    type: oauth2
    flow: implicit
    authorizationUrl: ""   # ignored by ESPv2
    x-google-issuer: "https://pnqnlqjkcslkiodsdjhe.supabase.co/auth/v1"
    x-google-jwks_uri: "https://pnqnlqjkcslkiodsdjhe.supabase.co/auth/v1/keys"
    x-google-audiences: "authenticated"
    x-google-jwt-locations:
      - header: "Authorization"
        value_prefix: "Bearer "

# ===== Cloud Run backend (applies to all paths) =====
x-google-backend:
  address: "https://innerpeace-api-379484922687.europe-west2.run.app"
  path_translation: APPEND_PATH_TO_ADDRESS
  jwt_audience: "https://innerpeace-api-379484922687.europe-west2.run.app"

paths:
  # ---- Health: PUBLIC ----
  /healthz:
    get:
      operationId: healthCheck
      security: []
      x-google-api-key: false
      responses:
        "200": { description: OK }
    options:
      operationId: healthPreflight
      security: []
      x-google-api-key: false
      responses:
        "204": { description: CORS preflight }

  # ---- YouTube: PUBLIC ----
  /api/youtube/channel/{id}:
    get:
      operationId: getYoutubeChannel
      security: []
      x-google-api-key: false
      parameters:
        - name: id
          in: path
          required: true
          type: string
      responses:
        "200": { description: OK }
    options:
      operationId: youtubePreflight
      security: []
      x-google-api-key: false
      # NOTE: no parameters on OPTIONS (fixes protobuf Empty/id error)
      responses:
        "204": { description: CORS preflight }

  # ---- Availability: PROTECTED ----
  /api/availability:
    get:
      operationId: getAvailability
      x-google-api-key: false
      parameters:
        - name: start
          in: query
          required: false
          type: string
        - name: end
          in: query
          required: false
          type: string
      responses:
        "200": { description: OK }
    options:
      operationId: availabilityPreflight
      security: []
      x-google-api-key: false
      responses:
        "204": { description: CORS preflight }

  # ---- Bookings: PROTECTED ----
  /api/bookings:
    get:
      operationId: listBookings
      x-google-api-key: false
      parameters:
        - name: uid
          in: query
          required: false
          type: string
      responses:
        "200": { description: OK }
    post:
      operationId: createBooking
      x-google-api-key: false
      responses:
        "200": { description: OK }
    options:
      operationId: bookingsPreflight
      security: []
      x-google-api-key: false
      responses:
        "204": { description: CORS preflight }

  /api/bookings/{id}:
    delete:
      operationId: deleteBooking
      x-google-api-key: false
      parameters:
        - name: id
          in: path
          required: true
          type: string
      responses:
        "200": { description: OK }
    put:
      operationId: updateBooking
      x-google-api-key: false
      parameters:
        - name: id
          in: path
          required: true
          type: string
      responses:
        "200": { description: OK }
    options:
      operationId: bookingsIdPreflight
      security: []
      x-google-api-key: false
      # NOTE: no parameters on OPTIONS
      responses:
        "204": { description: CORS preflight }

  # ---- Media: PROTECTED ----
  /api/media/list:
    get:
      operationId: listMedia
      x-google-api-key: false
      parameters:
        - name: folderId
          in: query
          required: false
          type: string
      responses:
        "200": { description: OK }
    options:
      operationId: mediaListPreflight
      security: []
      x-google-api-key: false
      responses:
        "204": { description: CORS preflight }

  /api/media/stream/{id}:
    get:
      operationId: streamMedia
      x-google-api-key: false
      parameters:
        - name: id
          in: path
          required: true
          type: string
      responses:
        "200": { description: OK }
        "206": { description: Partial content }
    options:
      operationId: mediaStreamPreflight
      security: []
      x-google-api-key: false
      # NOTE: no parameters on OPTIONS
      responses:
        "204": { description: CORS preflight }
