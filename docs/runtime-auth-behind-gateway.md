# Runtime auth behind API Gateway

When Cloud Run sits behind API Gateway, the gateway injects a Google ID token into the `Authorization` header before forwarding requests. Our frontend must continue sending the Supabase session in a separate header so the backend can authenticate end users.

## Headers

- `Authorization`: Google ID token generated by API Gateway for Cloud Run.
- `x-supabase-auth`: `Bearer <supabase_jwt>` provided by the frontend. The backend prefers this header and only falls back to `Authorization` when the JWT issuer contains `.supabase.co/auth/v1`.

## Validation flow

The backend validates the Supabase JWT via `supabaseAdmin.auth.getUser`. Successful validation populates `req.user` for downstream handlers. Structured logs (`auth.headers`, `auth.ok`, `auth.invalid`) remain available to aid troubleshooting.

## Required environment

Configure these variables in Cloud Run:

- `SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE_KEY`

With this setup, `/healthz` remains public for Cloud Run health probes that only include the Google ID token, while `/api/**` continues to require the Supabase session header.
